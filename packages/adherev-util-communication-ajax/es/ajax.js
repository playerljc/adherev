var __assign=this&&this.__assign||function(){return(__assign=Object.assign||function(t){for(var e,n=1,o=arguments.length;n<o;n++)for(var r in e=arguments[n])Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r]);return t}).apply(this,arguments)},__rest=this&&this.__rest||function(t,e){var n={};for(r in t)Object.prototype.hasOwnProperty.call(t,r)&&e.indexOf(r)<0&&(n[r]=t[r]);if(null!=t&&"function"==typeof Object.getOwnPropertySymbols)for(var o=0,r=Object.getOwnPropertySymbols(t);o<r.length;o++)e.indexOf(r[o])<0&&Object.prototype.propertyIsEnumerable.call(t,r[o])&&(n[r[o]]=t[r[o]]);return n};import{notification}from"ant-design-vue";import GlobalIndicator from"@baifendian/adherev-ui-globalindicator";import Util from"@baifendian/adherev-util";import intl from"@baifendian/adherev-util-intl";var errorInfoHandler,warnInfoHandler,trigger402=!1,notificationThrottlingTime=300,Ajax=function(){function t(t,e,n){this.baseURL=t||"",this.systemManagerBaseURL=e||"",this.config=n||{}}return t.prototype.get=function(t){var n=this,o=(t.data,__rest(t,["data"]));return new Promise(function(t,e){e=sendPrepare.call(n,__assign(__assign(__assign(__assign({},getDefaultConfig.call(n)),n.config),{method:"get"}),o),{resolve:t,reject:e}).xhr;e&&e.send(null)})},t.prototype.post=function(t){return complexRequest.call(this,"post",t)},t.prototype.path=function(t){return complexRequest.call(this,"path",t)},t.prototype.put=function(t){return complexRequest.call(this,"put",t)},t.prototype.delete=function(t){return complexRequest.call(this,"delete",t)},t.TIMEOUT=1e6,t.STATUS_SUCCESS_CODES=[200,201,202,203,204,205,206,207,208,226],t.STATUS_REDIRECT_CODES=[300,301,302,303,304,305,306,307,308],t.READY_STATE_UNSENT=0,t.READY_STATE_OPENED=1,t.READY_STATE_HEADERS_RECEIVED=2,t.READY_STATE_LOADING=3,t.READY_STATE_DONE=4,t.CONTENT_TYPE_APPLICATION_JSON="application/json",t.CONTENT_TYPE_MULTIPART_FORM_DATA="multipart/form-data",t.CONTENT_TYPE_APPLICATION_X_WWW_FORM_URLENCODED="application/x-www-form-urlencoded",t.CONTENT_TYPE_TEXT_XML="text/xml",t.CONTENT_TYPE_APPLICATION_XML="application/xml",t.CONTENT_TYPE_TEXT_PLAIN="text/plain",t}();function errorInfo(t,e){errorInfoHandler&&(clearTimeout(errorInfoHandler),errorInfoHandler=null),errorInfoHandler=setTimeout(function(){notification.error({message:t,description:e})},notificationThrottlingTime)}function warnInfo(t,e){warnInfoHandler&&(clearTimeout(warnInfoHandler),warnInfoHandler=null),warnInfoHandler=setTimeout(function(){notification.warn({message:t,description:e})},notificationThrottlingTime)}function createXHR(){return new XMLHttpRequest}function getDefaultConfig(){var e=this;return{timeout:Ajax.TIMEOUT,withCredentials:!0,onLoad:function(){},onLoadsStart:function(){},onLoadend:function(){},onProgress:function(){},onTimeout:function(){warnInfo(intl.tv("提示"),intl.tv("请求超时"))},onAbort:function(){warnInfo(intl.tv("提示"),intl.tv("请求终止"))},onError:function(){errorInfo(intl.tv("提示"),intl.tv("请求发生错误"))},interceptor:function(t){switch(t.status){case 401:deal401.call(e);break;case 402:deal402.call(e);break;default:errorInfo(intl.tv("提示"),intl.tv("已提出请求，但未收到任何回复"))}},mock:!1,loading:{show:!1,text:"",el:document.body},onBeforeResponse:function(){},dataKey:"data",messageKey:"message",codeKey:"code",codeSuccess:200,showWarn:!0,responseType:""}}function initXhrEvents(t,e){var n=e.onTimeout,o=e.onLoadsStart,r=e.onProgress,a=e.onAbort,i=e.onError,s=e.onLoad,e=e.onLoadend;n&&t.addEventListener("timeout",n),o&&t.addEventListener("loadstart",o),r&&t.addEventListener("progress",r),a&&t.addEventListener("abort",a),i&&t.addEventListener("error",i),s&&t.addEventListener("load",s),e&&t.addEventListener("loadend",e)}function resolveData(t){var e=t.show,n=t.data,o=t.indicator,t=t.xhr;return __assign({xhr:t,data:n},e?{hideIndicator:function(){return GlobalIndicator.hide(o)}}:{})}function onreadystatechange(t){var e=t.xhr,n=t.interceptor,o=t.loading,r=o.show,a=o.indicator,i=t.business,s=i.messageKey,c=i.codeKey,d=i.codeSuccess,l=i.showWarn,u=t.resolve,o=t.reject;e.readyState===Ajax.READY_STATE_DONE&&(200<=e.status&&e.status<300||304===e.status?-1!==(i=e.getResponseHeader("Content-type")).indexOf(Ajax.CONTENT_TYPE_APPLICATION_JSON)?(t=JSON.parse(e.responseText),l&&c in t&&t[c]!==d&&warnInfo(intl.v("提示"),t[s]),u(resolveData({show:r,data:t,indicator:a,xhr:e}))):[Ajax.CONTENT_TYPE_TEXT_XML,Ajax.CONTENT_TYPE_TEXT_XML].includes(i)?u(resolveData({show:r,data:e.responseXML,indicator:a,xhr:e})):u(resolveData({show:r,data:e.response,indicator:a,xhr:e})):(n({status:e.status,statusText:e.statusText,response:e.response,responseText:e.responseText}),e.status&&o({status:e.status,statusText:e.statusText,response:e.response,responseText:e.responseText}),r&&a&&GlobalIndicator.hide(a)))}function isMultipartFormData(t){return t&&"form"in t&&"data"in t&&!Util.isEmpty(t.form)&&!Util.isEmpty(t.data)&&t.form instanceof HTMLFormElement}function sendPrepare(t,e){var n,o=t.method,r=t.path,a=t.headers,i=t.data,s=t.mock,c=t.loading,d=(t.onBeforeResponse,t.dataKey),l=void 0===d?"data":d,u=t.messageKey,f=void 0===u?"message":u,T=t.codeKey,p=void 0===T?"code":T,_=t.codeSuccess,h=void 0===_?200:_,d=t.showWarn,u=void 0===d||d,T=__rest(t,["method","path","headers","data","mock","loading","onBeforeResponse","dataKey","messageKey","codeKey","codeSuccess","showWarn"]),E=e.resolve,_=e.reject,d="".concat(intl.tv("加载中"),"..."),t=c.show,m=void 0!==t&&t,e=c.text,t=void 0===e?d:e,e=c.el,c=void 0===e?document.body:e;if(m&&(n=GlobalIndicator.show(c||document.body,t||d,1e3)),s)return setTimeout(function(){E(m?{data:r,hideIndicator:function(){GlobalIndicator.hide(n)}}:r)},200),{xhr:null,contentType:""};var e=this.baseURL,c=this.config,t=Object.assign(getDefaultConfig.call(this),c,T),d=t.timeout,s=t.withCredentials,c=t.responseType,T=t.interceptor,t=__rest(t,["timeout","withCredentials","responseType","interceptor"]),g=createXHR();g.open(o,"".concat(e,"/").concat(r),!0),g.timeout=d,g.withCredentials=s||!0,g.responseType=c||"";s="";if(!Util.isEmpty(a)&&Util.isObject(a))for(var w in"Content-Type"in a||isMultipartFormData(i)||(a["Content-Type"]="".concat(Ajax.CONTENT_TYPE_APPLICATION_JSON,";charset=utf-8")),s=null!==(c=a["Content-Type"])&&void 0!==c?c:"",a)g.setRequestHeader(w,a[w]);else!Util.isEmpty(i)&&Util.isRef(i)&&"get"!==o&&(isMultipartFormData(i)?s=Ajax.CONTENT_TYPE_MULTIPART_FORM_DATA:(s="".concat(Ajax.CONTENT_TYPE_APPLICATION_JSON,";charset=utf-8"),g.setRequestHeader("Content-Type","".concat(Ajax.CONTENT_TYPE_APPLICATION_JSON,";charset=utf-8"))));return initXhrEvents(g,t),g.onreadystatechange=onreadystatechange.bind(this,{xhr:g,interceptor:T,loading:{show:m,indicator:n},business:{dataKey:l,messageKey:f,codeKey:p,codeSuccess:h,showWarn:u},resolve:E,reject:_}),{xhr:g,contentType:s}}function getSendParams(t){var e=t.data,t=t.contentType,t=void 0===t?"":t;if(t.startsWith(Ajax.CONTENT_TYPE_APPLICATION_JSON)&&Util.isRef(e))return JSON.stringify(e);if(t.startsWith(Ajax.CONTENT_TYPE_APPLICATION_X_WWW_FORM_URLENCODED)&&Util.isObject(e))return Array.from(Object.keys(e)).map(function(t){return"".concat(t,"=").concat(encodeURIComponent(e[t]))}).join("&");if(Util.isObject(e)&&isMultipartFormData(e)){var n=new FormData(e.form);return Array.from(Object.keys(e.data)).forEach(function(t){n.append(t,e.data[t])}),n}if(t.startsWith(Ajax.CONTENT_TYPE_TEXT_PLAIN)){if(Util.isString(e))return e;if(Util.isObject(e))return JSON.stringify(e)}return e.toString()}function complexRequest(n,o){var r=this;return new Promise(function(t,e){t=sendPrepare.call(r,__assign(__assign(__assign(__assign({},getDefaultConfig.call(r)),r.config),{method:n}),o),{resolve:t,reject:e}),e=t.xhr,t=t.contentType;e&&e.send(getSendParams.call(r,{data:o.data,contentType:t}))})}function deal401(){if("undefined"!=typeof window){if(window.top&&window.top!==window&&window.top.postMessage("http_status_401","*"),trigger402)return!1;window.location.href=Util.casUrl({baseUrl:this.systemManagerBaseURL,enterUrl:window.location.href})}}function deal402(){if(trigger402=!0,"undefined"!=typeof window)return window.parent&&window.parent!==window?(window.parent.postMessage("http_status_402","*"),!1):void(window.location.href=Util.casLogoutUrl({baseUrl:this.systemManagerBaseURL,enterUrl:window.location.href,params:"&code=402"}))}export default Ajax;
//# sourceMappingURL=ajax.js.map
