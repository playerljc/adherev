var __assign=this&&this.__assign||function(){return(__assign=Object.assign||function(t){for(var e,n=1,o=arguments.length;n<o;n++)for(var a in e=arguments[n])Object.prototype.hasOwnProperty.call(e,a)&&(t[a]=e[a]);return t}).apply(this,arguments)},__rest=this&&this.__rest||function(t,e){var n={};for(a in t)Object.prototype.hasOwnProperty.call(t,a)&&e.indexOf(a)<0&&(n[a]=t[a]);if(null!=t&&"function"==typeof Object.getOwnPropertySymbols)for(var o=0,a=Object.getOwnPropertySymbols(t);o<a.length;o++)e.indexOf(a[o])<0&&Object.prototype.propertyIsEnumerable.call(t,a[o])&&(n[a[o]]=t[a[o]]);return n};import GlobalIndicator from"@baifendian/adherev-ui-globalindicator";import Util from"@baifendian/adherev-util";import intl from"@baifendian/adherev-util-intl";import{notification}from"ant-design-vue";var errorInfoHandler,warnInfoHandler,trigger402=!1,notificationThrottlingTime=2e3;function errorInfo(t,e){errorInfoHandler&&(clearTimeout(errorInfoHandler),errorInfoHandler=null),errorInfoHandler=setTimeout(function(){notification.error({message:t,description:e})},notificationThrottlingTime)}function warnInfo(t,e){warnInfoHandler&&(clearTimeout(warnInfoHandler),warnInfoHandler=null),warnInfoHandler=setTimeout(function(){notification.warn({message:t,description:e})},notificationThrottlingTime)}function createXHR(){return new XMLHttpRequest}function getDefaultConfig(){var e=this;return{timeout:Ajax.TIMEOUT,withCredentials:!0,onLoad:function(){},onLoadsStart:function(){},onLoadend:function(){},onProgress:function(){},onTimeout:function(){warnInfo(intl.tv("提示"),intl.tv("请求超时"))},onAbort:function(){warnInfo(intl.tv("提示"),intl.tv("请求终止"))},onError:function(){errorInfo(intl.tv("提示"),intl.tv("请求发生错误"))},interceptor:function(t){switch(t.status){case 401:deal401.call(e);break;case 402:deal402.call(e);break;default:errorInfo(intl.tv("提示"),intl.tv("已提出请求，但未收到任何回复"))}},loading:{show:!1,text:"",el:document.body}}}function initXhrEvents(t,e){var n=e.onTimeout,o=e.onLoadsStart,a=e.onProgress,r=e.onAbort,i=e.onError,s=e.onLoad,e=e.onLoadend;n&&t.addEventListener("timeout",n),o&&t.addEventListener("loadstart",o),a&&t.addEventListener("progress",a),r&&t.addEventListener("abort",r),i&&t.addEventListener("error",i),s&&t.addEventListener("load",s),e&&t.addEventListener("loadend",e)}function resolveData(t){var e=t.show,n=t.data,o=t.indicator;return e?{data:n,hideIndicator:function(){GlobalIndicator.hide(o)}}:n}function onreadystatechange(t){var e,n=t.xhr,d=t.interceptor,o=t.loading,a=o.show,o=o.indicator,r=t.business,u=r.messageKey,T=r.codeKey,f=r.codeSuccess,r=r.showWarn,i=t.resolve,t=t.reject,s=n.status,l=n.readyState,c=n.statusText,_=n.response,p=n.responseText;l===Ajax.READY_STATE_DONE&&(200<=s&&s<300||304===s?-1!==(l=n.getResponseHeader("Content-type")).indexOf(Ajax.CONTENT_TYPE_APPLICATION_JSON)?(e=JSON.parse(n.responseText),r&&e[T]!==f&&warnInfo(intl.tv("提示"),e[u]),i(resolveData({show:a,data:e,indicator:o}))):[Ajax.CONTENT_TYPE_TEXT_XML,Ajax.CONTENT_TYPE_TEXT_XML].includes(l)?i(resolveData({show:a,data:n.responseXML,indicator:o})):i(resolveData({show:a,data:n.response,indicator:o})):(d({status:s,statusText:c,response:_,responseText:p}),s&&t({status:s,statusText:c,response:_,responseText:p}),a&&o&&GlobalIndicator.hide(o)))}function sendPrepare(t,e){var d,n,u,T=e.resolve,e=e.reject,f=t.method,_=t.path,o=t.headers,a=t.data,r=t.mock,i=t.loading,p=(t.onBeforeResponse,t.dataKey),p=void 0===p?"data":p,E=t.messageKey,E=void 0===E?"message":E,h=t.codeKey,h=void 0===h?"code":h,m=t.codeSuccess,m=void 0===m?200:m,v=t.showWarn,v=void 0===v||v,t=__rest(t,["method","path","headers","data","mock","loading","onBeforeResponse","dataKey","messageKey","codeKey","codeSuccess","showWarn"]),s="".concat(intl.tv("加载中"),"..."),l=i.show,g=void 0!==l&&l,l=i.text,i=i.el,i=void 0===i?document.body:i;if(g&&(u=GlobalIndicator.show(i||document.body,(void 0===l?s:l)||s)),r)return setTimeout(function(){T(g?{data:_,hideIndicator:function(){GlobalIndicator.hide(u)}}:_)},200),{xhr:null,contentType:""};var i=this.baseURL,l=this.config,s=Object.assign(getDefaultConfig.call(this),l,t),r=s.timeout,l=s.withCredentials,t=s.interceptor,s=__rest(s,["timeout","withCredentials","interceptor"]),c=createXHR(),i=(c.open(f,"".concat(i,"/").concat(_),!0),c.timeout=r,c.withCredentials=l,"");if(null!==(r=Util.isEmpty)&&void 0!==r&&r.call(Util,o)||null===(n=Util.isObject)||void 0===n||!n.call(Util,o))null!==(l=Util.isEmpty)&&void 0!==l&&l.call(Util,a)||null===(d=Util.isRef)||void 0===d||!d.call(Util,a)||"get"===f||(!("form"in a&&"data"in a)||null!==(r=Util.isEmpty)&&void 0!==r&&r.call(Util,a.form)||null!==(n=Util.isEmpty)&&void 0!==n&&n.call(Util,a.data)||!(a.form instanceof HTMLFormElement)?(i="".concat(Ajax.CONTENT_TYPE_APPLICATION_JSON,";charset=utf-8"),c.setRequestHeader("Content-Type","".concat(Ajax.CONTENT_TYPE_APPLICATION_JSON,";charset=utf-8"))):i=Ajax.CONTENT_TYPE_MULTIPART_FORM_DATA);else for(var O in"Content-type"in o||"get"===f||(o["Content-Type"]="".concat(Ajax.CONTENT_TYPE_APPLICATION_JSON,";charset=utf-8"),i=o["Content-Type"]),o)c.setRequestHeader(O,o[O]);return initXhrEvents(c,s),c.onreadystatechange=onreadystatechange.bind(this,{xhr:c,interceptor:t,loading:{show:g,indicator:u},business:{dataKey:p,messageKey:E,codeKey:h,codeSuccess:m,showWarn:v},resolve:T,reject:e}),{xhr:c,contentType:i}}function getSendParams(t){var e,n,o,a,r=t.data,t=t.contentType;return 0===(t=t||"").indexOf(Ajax.CONTENT_TYPE_APPLICATION_JSON)&&null!==(e=Util.isRef)&&void 0!==e&&e.call(Util,r)?JSON.stringify(r):0===t.indexOf(Ajax.CONTENT_TYPE_APPLICATION_X_WWW_FORM_URLENCODED)&&null!==(n=Util.isObject)&&void 0!==n&&n.call(Util,r)?Array.from(Object.keys(r)).map(function(t){return encodeURIComponent("".concat(t,"=").concat(r[t]))}).join("&"):0===t.indexOf(Ajax.CONTENT_TYPE_MULTIPART_FORM_DATA)&&null!==(o=Util.isObject)&&void 0!==o&&o.call(Util,r)?(a=new FormData(r.form),Array.from(Object.keys(r.data)).forEach(function(t){a.append(t,r.data[t])}),a):void 0}function complexRequest(n,o){var a=this;return new Promise(function(t,e){t=sendPrepare.call(a,__assign(__assign(__assign(__assign({},getDefaultConfig.call(a)),a.config),{method:n}),o),{resolve:t,reject:e}),e=t.xhr,t=t.contentType;e&&e.send(getSendParams.call(a,{data:o.data,contentType:t}))})}function deal401(){var t;if(window.top&&window.top!==window&&window.top.postMessage("http_status_401","*"),trigger402)return!1;window.location.href=null===(t=Util.casUrl)||void 0===t?void 0:t.call(Util,{baseUrl:this.systemManagerBaseURL,enterUrl:window.location.href})}function deal402(){var t;if(trigger402=!0,window.parent&&window.parent!==window)return window.parent.postMessage("http_status_402","*"),!1;window.location.href=null===(t=Util.casLogoutUrl)||void 0===t?void 0:t.call(Util,{baseUrl:this.systemManagerBaseURL,enterUrl:window.location.href,params:"&code=402"})}var Ajax=function(){function t(t,e,n){this.baseURL=t||"",this.systemManagerBaseURL=e||"",this.config=n||{}}return t.prototype.get=function(t){var n=this,o=(t.data,__rest(t,["data"]));return new Promise(function(t,e){t=sendPrepare.call(n,__assign(__assign(__assign(__assign({},getDefaultConfig.call(n)),n.config),{method:"get"}),o),{resolve:t,reject:e}).xhr;t&&t.send(null)})},t.prototype.post=function(t){return complexRequest.call(this,"post",t)},t.prototype.path=function(t){return complexRequest.call(this,"path",t)},t.prototype.put=function(t){return complexRequest.call(this,"put",t)},t.prototype.delete=function(t){return complexRequest.call(this,"delete",t)},t.TIMEOUT=1e6,t.STATUS_SUCCESS_CODES=[200,201,202,203,204,205,206,207,208,226],t.STATUS_REDIRECT_CODES=[300,301,302,303,304,305,306,307,308],t.READY_STATE_UNSENT=0,t.READY_STATE_OPENED=1,t.READY_STATE_HEADERS_RECEIVED=2,t.READY_STATE_LOADING=3,t.READY_STATE_DONE=4,t.CONTENT_TYPE_APPLICATION_JSON="application/json",t.CONTENT_TYPE_MULTIPART_FORM_DATA="multipart/form-data",t.CONTENT_TYPE_APPLICATION_X_WWW_FORM_URLENCODED="application/x-www-form-urlencoded",t.CONTENT_TYPE_TEXT_XML="text/xml",t.CONTENT_TYPE_APPLICATION_XML="application/xml",t.CONTENT_TYPE_TEXT_PLAIN="text/plain",t}();export default Ajax;
//# sourceMappingURL=ajax.js.map
