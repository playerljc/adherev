"use strict";var __assign=this&&this.__assign||function(){return(__assign=Object.assign||function(e){for(var t,n=1,a=arguments.length;n<a;n++)for(var r in t=arguments[n])Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r]);return e}).apply(this,arguments)},__rest=this&&this.__rest||function(e,t){var n={};for(r in e)Object.prototype.hasOwnProperty.call(e,r)&&t.indexOf(r)<0&&(n[r]=e[r]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols)for(var a=0,r=Object.getOwnPropertySymbols(e);a<r.length;a++)t.indexOf(r[a])<0&&Object.prototype.propertyIsEnumerable.call(e,r[a])&&(n[r[a]]=e[r[a]]);return n},__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0});var errorInfoHandler,warnInfoHandler,ant_design_vue_1=require("ant-design-vue"),adherev_util_1=__importDefault(require("@baifendian/adherev-util")),adherev_util_intl_1=__importDefault(require("@baifendian/adherev-util-intl")),adherev_ui_globalindicator_1=__importDefault(require("@baifendian/adherev-ui-globalindicator")),trigger402=!1,notificationThrottlingTime=2e3;function errorInfo(e,t){errorInfoHandler&&(clearTimeout(errorInfoHandler),errorInfoHandler=null),errorInfoHandler=setTimeout(function(){ant_design_vue_1.notification.error({message:e,description:t})},notificationThrottlingTime)}function warnInfo(e,t){warnInfoHandler&&(clearTimeout(warnInfoHandler),warnInfoHandler=null),warnInfoHandler=setTimeout(function(){ant_design_vue_1.notification.warn({message:e,description:t})},notificationThrottlingTime)}function createXHR(){return new XMLHttpRequest}function getDefaultConfig(){var t=this;return{timeout:Ajax.TIMEOUT,withCredentials:!0,onLoad:function(){},onLoadsStart:function(){},onLoadend:function(){},onProgress:function(){},onTimeout:function(){warnInfo(adherev_util_intl_1.default.tv("提示"),adherev_util_intl_1.default.tv("请求超时"))},onAbort:function(){warnInfo(adherev_util_intl_1.default.tv("提示"),adherev_util_intl_1.default.tv("请求终止"))},onError:function(){errorInfo(adherev_util_intl_1.default.tv("提示"),adherev_util_intl_1.default.tv("请求发生错误"))},interceptor:function(e){switch(e.status){case 401:deal401.call(t);break;case 402:deal402.call(t);break;default:errorInfo(adherev_util_intl_1.default.tv("提示"),adherev_util_intl_1.default.tv("已提出请求，但未收到任何回复"))}},loading:{show:!1,text:"",el:document.body}}}function initXhrEvents(e,t){var n=t.onTimeout,a=t.onLoadsStart,r=t.onProgress,o=t.onAbort,i=t.onError,s=t.onLoad,t=t.onLoadend;n&&e.addEventListener("timeout",n),a&&e.addEventListener("loadstart",a),r&&e.addEventListener("progress",r),o&&e.addEventListener("abort",o),i&&e.addEventListener("error",i),s&&e.addEventListener("load",s),t&&e.addEventListener("loadend",t)}function resolveData(e){var t=e.show,n=e.data,a=e.indicator;return t?{data:n,hideIndicator:function(){adherev_ui_globalindicator_1.default.hide(a)}}:n}function onreadystatechange(e){var t=e.xhr,n=e.interceptor,a=e.loading,r=a.show,o=a.indicator,i=e.business,s=i.messageKey,d=i.codeKey,l=i.codeSuccess,_=i.showWarn,u=e.resolve,c=e.reject,f=t.status,T=t.readyState,h=t.statusText,a=t.response,i=t.responseText;T===Ajax.READY_STATE_DONE&&(200<=f&&f<300||304===f?-1!==(e=t.getResponseHeader("Content-type")).indexOf(Ajax.CONTENT_TYPE_APPLICATION_JSON)?(T=JSON.parse(t.responseText),_&&T[d]!==l&&warnInfo(adherev_util_intl_1.default.tv("提示"),T[s]),u(resolveData({show:r,data:T,indicator:o}))):[Ajax.CONTENT_TYPE_TEXT_XML,Ajax.CONTENT_TYPE_TEXT_XML].includes(e)?u(resolveData({show:r,data:t.responseXML,indicator:o})):u(resolveData({show:r,data:t.response,indicator:o})):(n({status:f,statusText:h,response:a,responseText:i}),f&&c({status:f,statusText:h,response:a,responseText:i}),r&&o&&adherev_ui_globalindicator_1.default.hide(o)))}function sendPrepare(e,t){var n,a=e.method,r=e.path,o=e.headers,i=e.data,s=e.mock,d=e.loading,l=(e.onBeforeResponse,e.dataKey),_=void 0===l?"data":l,u=e.messageKey,c=void 0===u?"message":u,f=e.codeKey,T=void 0===f?"code":f,h=e.codeSuccess,l=void 0===h?200:h,u=e.showWarn,f=void 0===u||u,h=__rest(e,["method","path","headers","data","mock","loading","onBeforeResponse","dataKey","messageKey","codeKey","codeSuccess","showWarn"]),p=t.resolve,u=t.reject,e="".concat(adherev_util_intl_1.default.tv("加载中"),"..."),t=d.show,v=void 0!==t&&t,t=d.text,d=d.el,d=void 0===d?document.body:d;if(v&&(n=adherev_ui_globalindicator_1.default.show(d||document.body,(void 0===t?e:t)||e)),s)return setTimeout(function(){p(v?{data:r,hideIndicator:function(){adherev_ui_globalindicator_1.default.hide(n)}}:r)},200),{xhr:null,contentType:""};var d=this.baseURL,t=this.config,e=Object.assign(getDefaultConfig.call(this),t,h),s=e.timeout,t=e.withCredentials,h=e.interceptor,e=__rest(e,["timeout","withCredentials","interceptor"]),E=createXHR();E.open(a,"".concat(d,"/").concat(r),!0),E.timeout=s,E.withCredentials=t;t="";if(!adherev_util_1.default.isEmpty(o)&&adherev_util_1.default.isObject(o))for(var g in"Content-type"in o||"get"===a||(o["Content-Type"]="".concat(Ajax.CONTENT_TYPE_APPLICATION_JSON,";charset=utf-8"),t=o["Content-Type"]),o)E.setRequestHeader(g,o[g]);else!adherev_util_1.default.isEmpty(i)&&adherev_util_1.default.isRef(i)&&"get"!==a&&("form"in i&&"data"in i&&!adherev_util_1.default.isEmpty(i.form)&&!adherev_util_1.default.isEmpty(i.data)&&i.form instanceof HTMLFormElement?t=Ajax.CONTENT_TYPE_MULTIPART_FORM_DATA:(t="".concat(Ajax.CONTENT_TYPE_APPLICATION_JSON,";charset=utf-8"),E.setRequestHeader("Content-Type","".concat(Ajax.CONTENT_TYPE_APPLICATION_JSON,";charset=utf-8"))));return initXhrEvents(E,e),E.onreadystatechange=onreadystatechange.bind(this,{xhr:E,interceptor:h,loading:{show:v,indicator:n},business:{dataKey:_,messageKey:c,codeKey:T,codeSuccess:l,showWarn:f},resolve:p,reject:u}),{xhr:E,contentType:t}}function getSendParams(e){var t=e.data,e=e.contentType;if(0===(e=e||"").indexOf(Ajax.CONTENT_TYPE_APPLICATION_JSON)&&adherev_util_1.default.isRef(t))return JSON.stringify(t);if(0===e.indexOf(Ajax.CONTENT_TYPE_APPLICATION_X_WWW_FORM_URLENCODED)&&adherev_util_1.default.isObject(t))return Array.from(Object.keys(t)).map(function(e){return encodeURIComponent("".concat(e,"=").concat(t[e]))}).join("&");if(0===e.indexOf(Ajax.CONTENT_TYPE_MULTIPART_FORM_DATA)&&adherev_util_1.default.isObject(t)){var n=new FormData(t.form);return Array.from(Object.keys(t.data)).forEach(function(e){n.append(e,t.data[e])}),n}}function complexRequest(n,a){var r=this;return new Promise(function(e,t){e=sendPrepare.call(r,__assign(__assign(__assign(__assign({},getDefaultConfig.call(r)),r.config),{method:n}),a),{resolve:e,reject:t}),t=e.xhr,e=e.contentType;t&&t.send(getSendParams.call(r,{data:a.data,contentType:e}))})}function deal401(){if(window.top&&window.top!==window&&window.top.postMessage("http_status_401","*"),trigger402)return!1;window.location.href=adherev_util_1.default.casUrl({baseUrl:this.systemManagerBaseURL,enterUrl:window.location.href})}function deal402(){if(trigger402=!0,window.parent&&window.parent!==window)return window.parent.postMessage("http_status_402","*"),!1;window.location.href=adherev_util_1.default.casLogoutUrl({baseUrl:this.systemManagerBaseURL,enterUrl:window.location.href,params:"&code=402"})}var Ajax=function(){function e(e,t,n){this.baseURL=e||"",this.systemManagerBaseURL=t||"",this.config=n||{}}return e.prototype.get=function(e){var n=this,a=(e.data,__rest(e,["data"]));return new Promise(function(e,t){t=sendPrepare.call(n,__assign(__assign(__assign(__assign({},getDefaultConfig.call(n)),n.config),{method:"get"}),a),{resolve:e,reject:t}).xhr;t&&t.send(null)})},e.prototype.post=function(e){return complexRequest.call(this,"post",e)},e.prototype.path=function(e){return complexRequest.call(this,"path",e)},e.prototype.put=function(e){return complexRequest.call(this,"put",e)},e.prototype.delete=function(e){return complexRequest.call(this,"delete",e)},e.TIMEOUT=1e6,e.STATUS_SUCCESS_CODES=[200,201,202,203,204,205,206,207,208,226],e.STATUS_REDIRECT_CODES=[300,301,302,303,304,305,306,307,308],e.READY_STATE_UNSENT=0,e.READY_STATE_OPENED=1,e.READY_STATE_HEADERS_RECEIVED=2,e.READY_STATE_LOADING=3,e.READY_STATE_DONE=4,e.CONTENT_TYPE_APPLICATION_JSON="application/json",e.CONTENT_TYPE_MULTIPART_FORM_DATA="multipart/form-data",e.CONTENT_TYPE_APPLICATION_X_WWW_FORM_URLENCODED="application/x-www-form-urlencoded",e.CONTENT_TYPE_TEXT_XML="text/xml",e.CONTENT_TYPE_APPLICATION_XML="application/xml",e.CONTENT_TYPE_TEXT_PLAIN="text/plain",e}();exports.default=Ajax;
//# sourceMappingURL=ajax.js.map
