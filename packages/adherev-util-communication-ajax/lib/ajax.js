var __assign=this&&this.__assign||function(){return(__assign=Object.assign||function(t){for(var e,n=1,o=arguments.length;n<o;n++)for(var a in e=arguments[n])Object.prototype.hasOwnProperty.call(e,a)&&(t[a]=e[a]);return t}).apply(this,arguments)},__rest=this&&this.__rest||function(t,e){var n={};for(a in t)Object.prototype.hasOwnProperty.call(t,a)&&e.indexOf(a)<0&&(n[a]=t[a]);if(null!=t&&"function"==typeof Object.getOwnPropertySymbols)for(var o=0,a=Object.getOwnPropertySymbols(t);o<a.length;o++)e.indexOf(a[o])<0&&Object.prototype.propertyIsEnumerable.call(t,a[o])&&(n[a[o]]=t[a[o]]);return n};import{notification}from"ant-design-vue";import Util from"@baifendian/adherev-util";import intl from"@baifendian/adherev-util-intl";import GlobalIndicator from"@baifendian/adherev-ui-globalindicator";var trigger402=!1;function errorInfo(t,e){notification.error({message:t,description:e})}function warnInfo(t,e){notification.warn({message:t,description:e})}function createXHR(){return new XMLHttpRequest}function getDefaultConfig(){var e=this;return{timeout:Ajax.TIMEOUT,withCredentials:!0,onLoad:function(){},onLoadsStart:function(){},onLoadend:function(){},onProgress:function(){},onTimeout:function(){warnInfo(intl.tv("提示"),intl.tv("请求超时"))},onAbort:function(){warnInfo(intl.tv("提示"),intl.tv("请求终止"))},onError:function(){errorInfo(intl.tv("提示"),intl.tv("请求发生错误"))},interceptor:function(t){switch(t.status){case 401:deal401.call(e);break;case 402:deal402.call(e)}},loading:{show:!1,text:"",el:document.body}}}function initXhrEvents(t,e){var n=e.onTimeout,o=e.onLoadsStart,a=e.onProgress,r=e.onAbort,i=e.onError,s=e.onLoad,e=e.onLoadend;n&&t.addEventListener("timeout",n),o&&t.addEventListener("loadstart",o),a&&t.addEventListener("progress",a),r&&t.addEventListener("abort",r),i&&t.addEventListener("error",i),s&&t.addEventListener("load",s),e&&t.addEventListener("loadend",e)}function resolveData(t){var e=t.show,n=t.data,o=t.indicator;return e?{data:n,hideIndicator:function(){GlobalIndicator.hide(o)}}:n}function onreadystatechange(t){var e=t.xhr,n=t.interceptor,o=t.loading,a=o.show,r=o.indicator,i=t.business,s=i.messageKey,d=i.codeKey,c=i.codeSuccess,l=i.showWarn,u=t.resolve,T=t.reject,f=e.status,p=e.readyState,_=e.statusText,o=e.response,i=e.responseText;p===Ajax.READY_STATE_DONE&&(200<=f&&f<300||304===f?-1!==(t=e.getResponseHeader("Content-type")).indexOf(Ajax.CONTENT_TYPE_APPLICATION_JSON)?(p=JSON.parse(e.responseText),l&&p[d]!==c&&warnInfo(intl.tv("提示"),p[s]),u(resolveData({show:a,data:p,indicator:r}))):[Ajax.CONTENT_TYPE_TEXT_XML,Ajax.CONTENT_TYPE_TEXT_XML].includes(t)?u(resolveData({show:a,data:e.responseXML,indicator:r})):u(resolveData({show:a,data:e.response,indicator:r})):(errorInfo(intl.tv("提示"),intl.tv("已提出请求，但未收到任何回复")),n({status:f,statusText:_,response:o,responseText:i}),f&&T({status:f,statusText:_,response:o,responseText:i}),a&&r&&GlobalIndicator.hide(r)))}function sendPrepare(t,e){var n,o=e.resolve,a=e.reject,r=t.method,i=t.path,s=t.headers,d=t.data,c=t.mock,l=t.loading,u=(t.onBeforeResponse,t.dataKey),T=void 0===u?"data":u,f=t.messageKey,p=void 0===f?"message":f,_=t.codeKey,E=void 0===_?"code":_,e=t.codeSuccess,u=void 0===e?200:e,f=t.showWarn,_=void 0===f||f,e=__rest(t,["method","path","headers","data","mock","loading","onBeforeResponse","dataKey","messageKey","codeKey","codeSuccess","showWarn"]),f=intl.tv("加载中")+"...",t=l.show,h=void 0!==t&&t,t=l.text,t=void 0===t?f:t,l=l.el,l=void 0===l?document.body:l;if(h&&(n=GlobalIndicator.show(l||document.body,t||f)),c)return setTimeout(function(){o(h?{data:i,hideIndicator:function(){GlobalIndicator.hide(n)}}:i)},200),{xhr:null,contentType:""};var l=this.baseURL,t=this.config,f=Object.assign(getDefaultConfig.call(this),t,e),c=f.timeout,t=f.withCredentials,e=f.interceptor,f=__rest(f,["timeout","withCredentials","interceptor"]),O=createXHR();O.open(r,l+"/"+i,!0),O.timeout=c,O.withCredentials=t;t="";if(!Util.isEmpty(s)&&Util.isObject(s))for(var m in"Content-type"in s||"get"===r||(s["Content-Type"]=Ajax.CONTENT_TYPE_APPLICATION_JSON+";charset=utf-8",t=s["Content-Type"]),s)O.setRequestHeader(m,s[m]);else!Util.isEmpty(d)&&Util.isRef(d)&&"get"!==r&&("form"in d&&"data"in d&&!Util.isEmpty(d.form)&&!Util.isEmpty(d.data)&&d.form instanceof HTMLFormElement?t=Ajax.CONTENT_TYPE_MULTIPART_FORM_DATA:(t=Ajax.CONTENT_TYPE_APPLICATION_JSON+";charset=utf-8",O.setRequestHeader("Content-Type",Ajax.CONTENT_TYPE_APPLICATION_JSON+";charset=utf-8")));return initXhrEvents(O,f),O.onreadystatechange=onreadystatechange.bind(this,{xhr:O,interceptor:e,loading:{show:h,indicator:n},business:{dataKey:T,messageKey:p,codeKey:E,codeSuccess:u,showWarn:_},resolve:o,reject:a}),{xhr:O,contentType:t}}function getSendParams(t){var e=t.data,t=t.contentType;if(0===(t=t||"").indexOf(Ajax.CONTENT_TYPE_APPLICATION_JSON)&&Util.isRef(e))return JSON.stringify(e);if(0===t.indexOf(Ajax.CONTENT_TYPE_APPLICATION_X_WWW_FORM_URLENCODED)&&Util.isObject(e))return Array.from(Object.keys(e)).map(function(t){return encodeURIComponent(t+"="+e[t])}).join("&");if(0===t.indexOf(Ajax.CONTENT_TYPE_MULTIPART_FORM_DATA)&&Util.isObject(e)){var n=new FormData(e.form);return Array.from(Object.keys(e.data)).forEach(function(t){n.append(t,e.data[t])}),n}}function complexRequest(n,o){var a=this;return new Promise(function(t,e){t=sendPrepare.call(a,__assign(__assign(__assign({},getDefaultConfig.call(a)),{method:n}),o),{resolve:t,reject:e}),e=t.xhr,t=t.contentType;e&&e.send(getSendParams.call(a,{data:o.data,contentType:t}))})}function deal401(){if(window.top&&window.top!==window&&window.top.postMessage("http_status_401","*"),trigger402)return!1;window.location.href=Util.casUrl({baseUrl:this.systemManagerBaseURL,enterUrl:window.location.href})}function deal402(){if(trigger402=!0,window.parent&&window.parent!==window)return window.parent.postMessage("http_status_402","*"),!1;window.location.href=Util.casLogoutUrl({baseUrl:this.systemManagerBaseURL,enterUrl:window.location.href,params:"&code=402"})}var Ajax=function(){function t(t,e,n){this.baseURL=t||"",this.systemManagerBaseURL=e||"",this.config=n||{}}return t.prototype.get=function(t){var n=this,o=(t.data,__rest(t,["data"]));return new Promise(function(t,e){e=sendPrepare.call(n,__assign(__assign(__assign({},getDefaultConfig.call(n)),{method:"get"}),o),{resolve:t,reject:e}).xhr;e&&e.send(null)})},t.prototype.post=function(t){return complexRequest.call(this,"post",t)},t.prototype.path=function(t){return complexRequest.call(this,"path",t)},t.prototype.put=function(t){return complexRequest.call(this,"put",t)},t.prototype.delete=function(t){return complexRequest.call(this,"delete",t)},t.TIMEOUT=1e6,t.STATUS_SUCCESS_CODES=[200,201,202,203,204,205,206,207,208,226],t.STATUS_REDIRECT_CODES=[300,301,302,303,304,305,306,307,308],t.READY_STATE_UNSENT=0,t.READY_STATE_OPENED=1,t.READY_STATE_HEADERS_RECEIVED=2,t.READY_STATE_LOADING=3,t.READY_STATE_DONE=4,t.CONTENT_TYPE_APPLICATION_JSON="application/json",t.CONTENT_TYPE_MULTIPART_FORM_DATA="multipart/form-data",t.CONTENT_TYPE_APPLICATION_X_WWW_FORM_URLENCODED="application/x-www-form-urlencoded",t.CONTENT_TYPE_TEXT_XML="text/xml",t.CONTENT_TYPE_APPLICATION_XML="application/xml",t.CONTENT_TYPE_TEXT_PLAIN="text/plain",t}();export default Ajax;
//# sourceMappingURL=ajax.js.map
