"use strict";require("core-js/modules/es.object.define-property.js"),require("core-js/modules/es.number.constructor.js"),require("core-js/modules/es.object.to-string.js"),require("core-js/modules/es.array.iterator.js"),require("core-js/modules/es.map.js"),require("core-js/modules/es.string.iterator.js"),require("core-js/modules/esnext.map.delete-all.js"),require("core-js/modules/esnext.map.every.js"),require("core-js/modules/esnext.map.filter.js"),require("core-js/modules/esnext.map.find.js"),require("core-js/modules/esnext.map.find-key.js"),require("core-js/modules/esnext.map.includes.js"),require("core-js/modules/esnext.map.key-of.js"),require("core-js/modules/esnext.map.map-keys.js"),require("core-js/modules/esnext.map.map-values.js"),require("core-js/modules/esnext.map.merge.js"),require("core-js/modules/esnext.map.reduce.js"),require("core-js/modules/esnext.map.some.js"),require("core-js/modules/esnext.map.update.js"),require("core-js/modules/web.dom-collections.iterator.js"),Object.defineProperty(exports,"__esModule",{value:!0});var tslib_1=require("tslib"),debounce_1=tslib_1.__importDefault(require("lodash/debounce")),adherev_util_1=tslib_1.__importDefault(require("@baifendian/adherev-util")),resize_observer_1=require("@juggle/resize-observer"),types_1=require("./types"),selectorPrefix="adherev-ui-writingboard",BackTopAnimation={name:"adv-writingboard",props:{defaultMode:{type:String,default:types_1.Mode.FREE},defaultStrokeStyle:{type:String,default:"#000"},defaultLineWidth:{type:Number,default:2},resizeTime:{type:Number,default:300}},data:function(){return{$stack:[],$ctx:null,$ro:null,$config:null,$curShape:null,$lineWidth:null,$strokeStyle:null,$startPoint:null,$prePoint:null,$stackIndex:0}},methods:{drawStack:function(){for(var t=0;t<this.$data.$stack.length;t++){var e=this.$data.$stack[t];this.$data.$config.get(e.shape).drawStack(e)}},style:function(t){var e=t.lineWidth,t=t.strokeStyle;this.$data.$ctx.lineWidth=e,this.$data.$ctx.strokeStyle=t,this.$data.$ctx.lineCap="round",this.$data.$ctx.lineJoin="round"},triangle:function(t){var e=t.startPoint,t=t.targetPoint,a=this.getPoint({startPoint:e,targetPoint:t}),i=Math.abs(t.x-e.x),t=Math.abs(t.y-e.y);return[{x:a.x,y:a.y+t},{x:a.x+i/2,y:a.y},{x:a.x+i,y:a.y+t}]},devicePointToCanvasPoint:function(t){var e=t.clientX,t=t.clientY,a=this.$refs.canvasRef.getBoundingClientRect();return{x:e-a.x,y:t-a.y}},getDistanceByBetweenPoint:function(t){var e=t.p1,t=t.p2,a=e.x,e=e.y,i=t.x,t=t.y;return Math.sqrt(Math.pow(i-a,2)+Math.pow(t-e,2))},getPoint:function(t){var e=t.startPoint,t=t.targetPoint;return t.x<=e.x&&t.y<=e.y?t:t.x<=e.x&&t.y>=e.y?{x:t.x,y:e.y}:t.x>=e.x&&t.y<=e.y?{x:e.x,y:t.y}:t.x>=e.x&&t.y>=e.y?e:void 0},draw:function(t){var e=t.sourcePoint,t=t.targetPoint;this.$data.$config.get(this.$data.$curShape).draw({sourcePoint:e,targetPoint:t})},onMousedown:function(t){this.start(t)},onTouchstart:function(t){this.start(tslib_1.__assign(tslib_1.__assign({},t),{clientX:t.targetTouches[0].clientX,clientY:t.targetTouches[0].clientY}))},onMousemove:function(t){this.move(t)},onTouchmove:function(t){this.move(tslib_1.__assign(tslib_1.__assign({},t),{clientX:t.targetTouches[0].clientX,clientY:t.targetTouches[0].clientY}))},onMouseup:function(t){this.end(t)},onTouchend:function(t){this.end(tslib_1.__assign(tslib_1.__assign({},t),{clientX:t.changedTouches[0].clientX,clientY:t.changedTouches[0].clientY}))},start:function(t){var e=t.clientX,t=t.clientY;this.$data.$startPoint=this.$data.$prePoint=this.devicePointToCanvasPoint({clientX:e,clientY:t}),this.$refs.containerRef.addEventListener("mousemove",this.onMousemove),this.$refs.containerRef.addEventListener("mouseup",this.onMouseup),this.$refs.containerRef.addEventListener("touchmove",this.onTouchmove),this.$refs.containerRef.addEventListener("touchend",this.onTouchend)},move:function(t){var e=t.clientX,t=t.clientY,e=this.devicePointToCanvasPoint({clientX:e,clientY:t});this.draw({sourcePoint:this.$data.$prePoint,targetPoint:e}),this.$data.$prePoint=e},end:function(t){var e=t.clientX,t=t.clientY,e=this.devicePointToCanvasPoint({clientX:e,clientY:t});null!=(t=this.$data.$config.get(this.$data.$curShape))&&t.mouseup(e),this.$data.$startPoint=null,this.$data.$prePoint=null,this.$refs.containerRef.removeEventListener("mousemove",this.onMousemove),this.$refs.containerRef.removeEventListener("mouseup",this.onMouseup),this.$refs.containerRef.removeEventListener("touchmove",this.onTouchmove),this.$refs.containerRef.removeEventListener("touchend",this.onTouchend)},clear:function(){this.$data.$ctx.clearRect(0,0,this.$refs.canvasRef.width,this.$refs.canvasRef.height),this.$data.$prePoint=this.$data.$startPoint=null,this.$data.$stack=[],this.$data.$stackIndex=0},setMode:function(t){this.$data.$curShape=t},setStrokeStyle:function(t){this.$data.$strokeStyle=t},setLineWidth:function(t){this.$data.$lineWidth=t},toDataURL:function(t,e,a){var i,n;if(t){for(var t=adherev_util_1.default.colorToRgb(t),s=t[0],o=t[1],r=t[2],d=[],c=null==(t=this.$data.$ctx)?void 0:t.getImageData(0,0,this.$refs.canvasRef.width,this.$refs.canvasRef.height),u=0;u<(null==(i=null==c?void 0:c.data)?void 0:i.length);u+=4)0===c.data[u+3]&&(c.data[u]=s,c.data[u+1]=o,c.data[u+2]=r,c.data[u+3]=255,d.push(u),d.push(u+1),d.push(u+2),d.push(u+3));null!=(t=this.$data.$ctx)&&t.putImageData(c,0,0);t=null==(t=this.$refs.canvasRef)?void 0:t.toDataURL(e||"image/png",a),c=null==(n=this.$data.$ctx)?void 0:n.getImageData(0,0,this.$refs.canvasRef.width,this.$refs.canvasRef.height);return d.forEach(function(t){c.data[t]=0}),null!=(n=this.$data.$ctx)&&n.putImageData(c,0,0),t}return null==(n=this.$refs.canvasRef)?void 0:n.toDataURL(e||"image/png",a)}},created:function(){var i=this;this.$data.$curShape=this.defaultMode,this.$data.$lineWidth=this.defaultLineWidth,this.$data.$strokeStyle=this.defaultStrokeStyle,this.$data.$config=new Map([[types_1.Mode.FREE,{draw:function(t){var e=t.sourcePoint,t=t.targetPoint,a=i.$data.$ctx;a.beginPath(),a.moveTo(e.x,e.y),a.lineTo(t.x,t.y),i.$data.$stack.push({shape:i.$data.$curShape,sourcePoint:e,targetPoint:t}),i.style({lineWidth:i.$data.$lineWidth,strokeStyle:i.$data.$strokeStyle}),a.stroke()},drawStack:function(t){var e=i.$data.$ctx;e.beginPath(),e.moveTo(t.sourcePoint.x,t.sourcePoint.y),e.lineTo(t.targetPoint.x,t.targetPoint.y),i.style({lineWidth:t.lineWidth,strokeStyle:t.strokeStyle}),e.stroke()},mouseup:function(t){i.draw({sourcePoint:i.$data.$prePoint,targetPoint:t})}}],[types_1.Mode.LINE,{draw:function(t){var t=t.targetPoint,e=i.$data.$ctx;e.clearRect(0,0,i.$refs.canvasRef.width,i.$refs.canvasRef.height),i.drawStack(),e.beginPath(),e.moveTo(i.$data.$startPoint.x,i.$data.$startPoint.y),e.lineTo(t.x,t.y),i.style({lineWidth:i.$data.$lineWidth,strokeStyle:i.$data.$strokeStyle}),e.stroke()},drawStack:function(t){var e=i.$data.$ctx;e.beginPath(),e.moveTo(t.sourcePoint.x,t.sourcePoint.y),e.lineTo(t.targetPoint.x,t.targetPoint.y),i.style({lineWidth:t.lineWidth,strokeStyle:t.strokeStyle}),e.stroke()},mouseup:function(t){i.$data.$stack.push({shape:i.$data.$curShape,lineWidth:i.$data.$ctx.lineWidth,strokeStyle:i.$data.$ctx.strokeStyle,sourcePoint:i.$data.$startPoint,targetPoint:t})}}],[types_1.Mode.RECTANGLE,{draw:function(t){var t=t.targetPoint,e=i.$data.$ctx,a=(e.clearRect(0,0,i.$refs.canvasRef.width,i.$refs.canvasRef.height),i.drawStack(),e.beginPath(),i.getPoint({startPoint:i.$data.$startPoint,targetPoint:t}));e.rect(a.x,a.y,Math.abs(t.x-i.$data.$startPoint.x),Math.abs(t.y-i.$data.$startPoint.y)),i.style({lineWidth:i.$data.$lineWidth,strokeStyle:i.$data.$strokeStyle}),e.stroke()},drawStack:function(t){var e=i.$data.$ctx;e.beginPath(),e.rect(t.x,t.y,t.width,t.height),i.style({lineWidth:t.lineWidth,strokeStyle:t.strokeStyle}),e.stroke()},mouseup:function(t){var e=i.getPoint({startPoint:i.$data.$startPoint,targetPoint:t});i.$data.$stack.push({shape:i.$data.$curShape,lineWidth:i.$data.$ctx.lineWidth,strokeStyle:i.$data.$ctx.strokeStyle,x:e.x,y:e.y,width:Math.abs(t.x-i.$data.$startPoint.x),height:Math.abs(t.y-i.$data.$startPoint.y)})}}],[types_1.Mode.CIRCLE,{draw:function(t){var t=t.targetPoint,e=i.$data.$ctx,a=(e.clearRect(0,0,i.$refs.canvasRef.width,i.$refs.canvasRef.height),i.drawStack(),e.beginPath(),i.getPoint({startPoint:i.$data.$startPoint,targetPoint:t})),t=i.getDistanceByBetweenPoint({p2:t,p1:i.$data.$startPoint});e.ellipse(a.x,a.y,t,t,45*Math.PI/180,0,2*Math.PI),i.style({lineWidth:i.$data.$lineWidth,strokeStyle:i.$data.$strokeStyle}),e.stroke()},drawStack:function(t){var e=i.$data.$ctx;e.beginPath(),e.ellipse(t.x,t.y,t.radiusX,t.radiusY,t.rotation,t.startAngle,t.endAngle),i.style({lineWidth:t.lineWidth,strokeStyle:t.strokeStyle}),e.stroke()},mouseup:function(t){var e=i.getPoint({startPoint:i.$data.$startPoint,targetPoint:t}),t=i.getDistanceByBetweenPoint({p2:t,p1:i.$data.$startPoint});i.$data.$stack.push({shape:i.$data.$curShape,lineWidth:i.$data.$ctx.lineWidth,strokeStyle:i.$data.$ctx.strokeStyle,x:e.x,y:e.y,radiusX:t,radiusY:t,rotation:45*Math.PI/180,startAngle:0,endAngle:2*Math.PI})}}],[types_1.Mode.TRIANGLE,{draw:function(t){var t=t.targetPoint,e=i.$data.$ctx,t=(e.clearRect(0,0,i.$refs.canvasRef.width,i.$refs.canvasRef.height),i.drawStack(),e.beginPath(),i.triangle({startPoint:i.$data.$startPoint,targetPoint:t}));e.moveTo(t[0].x,t[0].y),e.lineTo(t[1].x,t[1].y),e.lineTo(t[2].x,t[2].y),e.closePath(),i.style({lineWidth:i.$data.$lineWidth,strokeStyle:i.$data.$strokeStyle}),e.stroke()},drawStack:function(t){var e=i.$data.$ctx;e.beginPath(),e.moveTo(t.points[0].x,t.points[0].y),e.lineTo(t.points[1].x,t.points[1].y),e.lineTo(t.points[2].x,t.points[2].y),e.closePath(),i.style({lineWidth:t.lineWidth,strokeStyle:t.strokeStyle}),e.stroke()},mouseup:function(t){t=i.triangle({startPoint:i.$data.$startPoint,targetPoint:t});i.$data.$stack.push({shape:i.$data.$curShape,lineWidth:i.$data.$ctx.lineWidth,strokeStyle:i.$data.$ctx.strokeStyle,points:t})}}],[types_1.Mode.RUBBER,{draw:function(t){var e=t.sourcePoint,t=t.targetPoint,a=i.$data.$ctx;a.beginPath(),a.moveTo(e.x,e.y),a.lineTo(t.x,t.y),i.$data.$stack.push({shape:i.$data.$curShape,sourcePoint:e,targetPoint:t}),a.lineWidth=15,a.strokeStyle="#fff",a.lineCap="round",a.lineJoin="round",a.stroke()},drawStack:function(t){var e=i.$data.$ctx;e.beginPath(),e.moveTo(t.sourcePoint.x,t.sourcePoint.y),e.lineTo(t.targetPoint.x,t.targetPoint.y),e.lineWidth=15,e.strokeStyle="#fff",e.lineCap="round",e.lineJoin="round",e.stroke()},mouseup:function(t){i.draw({sourcePoint:i.$data.$prePoint,targetPoint:t})}}]])},mounted:function(){var t,e=this,a=(this.$data.$ctx=this.$refs.canvasRef.getContext("2d"),this.$refs.canvasRef.width=this.$refs.containerRef.offsetWidth,this.$refs.canvasRef.height=this.$refs.containerRef.offsetHeight,(0,debounce_1.default)(function(){e.$refs.canvasRef.width=e.$refs.containerRef.offsetWidth,e.$refs.canvasRef.height=e.$refs.containerRef.offsetHeight,e.$data.$ctx.clearRect(0,0,e.$refs.canvasRef.width,e.$refs.canvasRef.height),e.drawStack()},this.resizeTime));this.$data.$ro=new resize_observer_1.ResizeObserver(a),null!=(t=(a=this.$data.$ro).observe)&&t.call(a,document.body),this.$refs.containerRef.addEventListener("mousedown",this.onMousedown),this.$refs.containerRef.addEventListener("touchstart",this.onTouchstart)},beforeDestroy:function(){this.$refs.containerRef.removeEventListener("mousedown",this.onMousedown),this.$refs.containerRef.removeEventListener("touchstart",this.onTouchstart)},render:function(t){return t("div",{ref:"containerRef",class:selectorPrefix},[t("canvas",{ref:"canvasRef"})])}};exports.default=BackTopAnimation;
//# sourceMappingURL=writingboard.js.map
