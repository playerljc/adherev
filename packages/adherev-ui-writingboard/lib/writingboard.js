"use strict";var _vue=require("vue"),tslib_1=(require("core-js/modules/es.object.define-property.js"),require("core-js/modules/es.array.iterator.js"),require("core-js/modules/es.map.js"),require("core-js/modules/es.object.to-string.js"),require("core-js/modules/es.string.iterator.js"),require("core-js/modules/esnext.map.delete-all.js"),require("core-js/modules/esnext.map.every.js"),require("core-js/modules/esnext.map.filter.js"),require("core-js/modules/esnext.map.find.js"),require("core-js/modules/esnext.map.find-key.js"),require("core-js/modules/esnext.map.includes.js"),require("core-js/modules/esnext.map.key-of.js"),require("core-js/modules/esnext.map.map-keys.js"),require("core-js/modules/esnext.map.map-values.js"),require("core-js/modules/esnext.map.merge.js"),require("core-js/modules/esnext.map.reduce.js"),require("core-js/modules/esnext.map.some.js"),require("core-js/modules/esnext.map.update.js"),require("core-js/modules/web.dom-collections.iterator.js"),Object.defineProperty(exports,"__esModule",{value:!0}),require("tslib")),debounce_1=tslib_1.__importDefault(require("lodash/debounce")),vue_1=require("vue"),vue_types_1=require("vue-types"),adherev_util_1=tslib_1.__importDefault(require("@baifendian/adherev-util")),resize_observer_1=require("@juggle/resize-observer"),types_1=require("./types"),selectorPrefix="adherev-ui-writingboard",props={defaultMode:(0,vue_types_1.string)().def(types_1.Mode.FREE),defaultStrokeStyle:(0,vue_types_1.string)().def("#000"),defaultLineWidth:(0,vue_types_1.number)().def(2),resizeTime:(0,vue_types_1.number)().def(300)};exports.default=(0,vue_1.defineComponent)({name:"adv-writingboard",props:props,setup:function(t,e){var e=e.expose,l=(0,vue_1.ref)(),v=(0,vue_1.ref)(),c=null,n=null,i=null,o=null,u=t.defaultMode,r=t.defaultLineWidth,s=t.defaultStrokeStyle,a=[],d=new Map([[types_1.Mode.FREE,{draw:function(e){var t=e.sourcePoint,e=e.targetPoint;null!=c&&c.beginPath(),null!=c&&c.moveTo(t.x,t.y),null!=c&&c.lineTo(e.x,e.y),a.push({shape:u,sourcePoint:t,targetPoint:e}),h({lineWidth:r,strokeStyle:s}),null!=c&&c.stroke()},drawStack:function(e){null!=c&&c.beginPath(),null!=c&&c.moveTo(e.sourcePoint.x,e.sourcePoint.y),null!=c&&c.lineTo(e.targetPoint.x,e.targetPoint.y),h({lineWidth:e.lineWidth,strokeStyle:e.strokeStyle}),null!=c&&c.stroke()},mouseup:function(e){P({sourcePoint:o,targetPoint:e})}}],[types_1.Mode.LINE,{draw:function(e){var t,e=e.targetPoint;null!=c&&c.clearRect(0,0,null==(t=v.value)?void 0:t.width,null==(t=v.value)?void 0:t.height),f(),null!=c&&c.beginPath(),null!=c&&c.moveTo(i.x,i.y),null!=c&&c.lineTo(e.x,e.y),h({lineWidth:r,strokeStyle:s}),null!=c&&c.stroke()},drawStack:function(e){null!=c&&c.beginPath(),null!=c&&c.moveTo(e.sourcePoint.x,e.sourcePoint.y),null!=c&&c.lineTo(e.targetPoint.x,e.targetPoint.y),h({lineWidth:e.lineWidth,strokeStyle:e.strokeStyle}),null!=c&&c.stroke()},mouseup:function(e){a.push({shape:u,lineWidth:null==c?void 0:c.lineWidth,strokeStyle:null==c?void 0:c.strokeStyle,sourcePoint:i,targetPoint:e})}}],[types_1.Mode.RECTANGLE,{draw:function(e){var e=e.targetPoint,t=(null!=c&&c.clearRect(0,0,null==(t=v.value)?void 0:t.width,null==(t=v.value)?void 0:t.height),f(),null!=c&&c.beginPath(),m({startPoint:i,targetPoint:e}));null!=c&&c.rect(t.x,t.y,Math.abs(e.x-i.x),Math.abs(e.y-i.y)),h({lineWidth:r,strokeStyle:s}),null!=c&&c.stroke()},drawStack:function(e){null!=c&&c.beginPath(),null!=c&&c.rect(e.x,e.y,e.width,e.height),h({lineWidth:e.lineWidth,strokeStyle:e.strokeStyle}),null!=c&&c.stroke()},mouseup:function(e){var t=m({startPoint:i,targetPoint:e});a.push({shape:u,lineWidth:null==c?void 0:c.lineWidth,strokeStyle:null==c?void 0:c.strokeStyle,x:t.x,y:t.y,width:Math.abs(e.x-(null==i?void 0:i.x)),height:Math.abs(e.y-(null==i?void 0:i.y))})}}],[types_1.Mode.CIRCLE,{draw:function(e){var e=e.targetPoint,t=(null!=c&&c.clearRect(0,0,null==(t=v.value)?void 0:t.width,null==(t=v.value)?void 0:t.height),f(),null!=c&&c.beginPath(),m({startPoint:i,targetPoint:e})),e=g({p2:e,p1:i});null!=c&&c.ellipse(t.x,t.y,e,e,45*Math.PI/180,0,2*Math.PI),h({lineWidth:r,strokeStyle:s}),null!=c&&c.stroke()},drawStack:function(e){null!=c&&c.beginPath(),null!=c&&c.ellipse(e.x,e.y,e.radiusX,e.radiusY,e.rotation,e.startAngle,e.endAngle),h({lineWidth:e.lineWidth,strokeStyle:e.strokeStyle}),null!=c&&c.stroke()},mouseup:function(e){var t=m({startPoint:i,targetPoint:e}),e=g({p2:e,p1:i});a.push({shape:u,lineWidth:null==c?void 0:c.lineWidth,strokeStyle:null==c?void 0:c.strokeStyle,x:t.x,y:t.y,radiusX:e,radiusY:e,rotation:45*Math.PI/180,startAngle:0,endAngle:2*Math.PI})}}],[types_1.Mode.TRIANGLE,{draw:function(e){var e=e.targetPoint,t=(null!=c&&c.clearRect(0,0,null==(t=v.value)?void 0:t.width,null==(t=v.value)?void 0:t.height),f(),null!=c&&c.beginPath(),y({startPoint:i,targetPoint:e}));null!=c&&c.moveTo(t[0].x,t[0].y),null!=c&&c.lineTo(t[1].x,t[1].y),null!=c&&c.lineTo(t[2].x,t[2].y),null!=c&&c.closePath(),h({lineWidth:r,strokeStyle:s}),null!=c&&c.stroke()},drawStack:function(e){null!=c&&c.beginPath(),null!=c&&c.moveTo(e.points[0].x,e.points[0].y),null!=c&&c.lineTo(e.points[1].x,e.points[1].y),null!=c&&c.lineTo(e.points[2].x,e.points[2].y),null!=c&&c.closePath(),h({lineWidth:e.lineWidth,strokeStyle:e.strokeStyle}),null!=c&&c.stroke()},mouseup:function(e){e=y({startPoint:i,targetPoint:e});a.push({shape:u,lineWidth:null==c?void 0:c.lineWidth,strokeStyle:null==c?void 0:c.strokeStyle,points:e})}}],[types_1.Mode.RUBBER,{draw:function(e){var t=e.sourcePoint,e=e.targetPoint;null!=c&&c.beginPath(),null!=c&&c.moveTo(t.x,t.y),null!=c&&c.lineTo(e.x,e.y),a.push({shape:u,sourcePoint:t,targetPoint:e}),c.lineWidth=15,c.strokeStyle="#fff",c.lineCap="round",c.lineJoin="round",null!=c&&c.stroke()},drawStack:function(e){null!=c&&c.beginPath(),null!=c&&c.moveTo(e.sourcePoint.x,e.sourcePoint.y),null!=c&&c.lineTo(e.targetPoint.x,e.targetPoint.y),c.lineWidth=15,c.strokeStyle="#fff",c.lineCap="round",c.lineJoin="round",null!=c&&c.stroke()},mouseup:function(e){P({sourcePoint:o,targetPoint:e})}}]]);function h(e){var t=e.lineWidth,e=e.strokeStyle;c.lineWidth=t,c.strokeStyle=e,c.lineCap="round",c.lineJoin="round"}function y(e){var t=e.startPoint,e=e.targetPoint,l=m({startPoint:t,targetPoint:e}),n=Math.abs(e.x-t.x),e=Math.abs(e.y-t.y);return[{x:l.x,y:l.y+e},{x:l.x+n/2,y:l.y},{x:l.x+n,y:l.y+e}]}function p(e){var t=e.clientX,e=e.clientY,l=null==(l=null==v?void 0:v.value)?void 0:l.getBoundingClientRect();return{x:t-l.x,y:e-l.y}}function g(e){var t=e.p1,e=e.p2,l=t.x,t=t.y,n=e.x,e=e.y;return Math.sqrt(Math.pow(n-l,2)+Math.pow(e-t,2))}function f(){for(var e=0;e<a.length;e++){var t=a[e];d.get(t.shape).drawStack(t)}}function m(e){var t=e.startPoint,e=e.targetPoint;return e.x<=t.x&&e.y<=t.y?e:e.x<=t.x&&e.y>=t.y?{x:e.x,y:t.y}:e.x>=t.x&&e.y<=t.y?{x:t.x,y:e.y}:e.x>=t.x&&e.y>=t.y?t:void 0}function P(e){var t=e.sourcePoint,e=e.targetPoint;(null==d?void 0:d.get(u)).draw({sourcePoint:t,targetPoint:e})}function x(e){W(e)}function _(e){W(tslib_1.__assign(tslib_1.__assign({},e),{clientX:e.targetTouches[0].clientX,clientY:e.targetTouches[0].clientY}))}function k(e){T(e)}function b(e){T(tslib_1.__assign(tslib_1.__assign({},e),{clientX:e.changedTouches[0].clientX,clientY:e.changedTouches[0].clientY}))}function j(e){w(e)}function S(e){w(tslib_1.__assign(tslib_1.__assign({},e),{clientX:e.targetTouches[0].clientX,clientY:e.targetTouches[0].clientY}))}function w(e){var t=e.clientX,e=e.clientY;i=o=p({clientX:t,clientY:e}),null!=(t=null==l?void 0:l.value)&&t.addEventListener("mousemove",x),null!=(e=null==l?void 0:l.value)&&e.addEventListener("mouseup",k),null!=(t=null==l?void 0:l.value)&&t.addEventListener("touchmove",_),null!=(e=null==l?void 0:l.value)&&e.addEventListener("touchend",b)}function W(e){e=p({clientX:e.clientX,clientY:e.clientY});P({sourcePoint:o,targetPoint:e}),o=e}function T(e){var t,e=p({clientX:e.clientX,clientY:e.clientY});null!=(t=d.get(u))&&t.mouseup(e),(o=i=null)!=(t=null==l?void 0:l.value)&&t.removeEventListener("mousemove",x),null!=(e=null==l?void 0:l.value)&&e.removeEventListener("mouseup",k),null!=(t=null==l?void 0:l.value)&&t.removeEventListener("touchmove",_),null!=(e=null==l?void 0:l.value)&&e.removeEventListener("touchend",b)}return e({setMode:function(e){u=e},setStrokeStyle:function(e){s=e},setLineWidth:function(e){r=e},clear:function(){var e;null!=c&&c.clearRect(0,0,null==(e=null==v?void 0:v.value)?void 0:e.width,null==(e=null==v?void 0:v.value)?void 0:e.height),o=i=null,a=[]},toDataURL:function(e,t,l){var n,i;if(e){for(var e=adherev_util_1.default.colorToRgb(e),o=e[0],u=e[1],r=e[2],s=[],a=null==c?void 0:c.getImageData(0,0,null==(e=null==v?void 0:v.value)?void 0:e.width,null==(e=null==v?void 0:v.value)?void 0:e.height),d=0;d<(null==(n=null==a?void 0:a.data)?void 0:n.length);d+=4)0===a.data[d+3]&&(a.data[d]=o,a.data[d+1]=u,a.data[d+2]=r,a.data[d+3]=255,s.push(d),s.push(d+1),s.push(d+2),s.push(d+3));null!=c&&c.putImageData(a,0,0);e=null==(e=null==v?void 0:v.value)?void 0:e.toDataURL(t||"image/png",l),a=null==c?void 0:c.getImageData(0,0,null==(i=null==v?void 0:v.value)?void 0:i.width,null==(i=null==v?void 0:v.value)?void 0:i.height);return s.forEach(function(e){a.data[e]=0}),null!=c&&c.putImageData(a,0,0),e}return null==(i=null==v?void 0:v.value)?void 0:i.toDataURL(t||"image/png",l)}}),(0,vue_1.onMounted)(function(){c=null==(e=null==v?void 0:v.value)?void 0:e.getContext("2d");var e=(0,debounce_1.default)(function(){var e;v.value.width=null==(e=null==l?void 0:l.value)?void 0:e.offsetWidth,v.value.height=null==(e=null==l?void 0:l.value)?void 0:e.offsetHeight,null!=c&&c.clearRect(0,0,null==(e=null==v?void 0:v.value)?void 0:e.width,null==(e=null==v?void 0:v.value)?void 0:e.height),f()},t.resizeTime);null!=(e=null==(n=new resize_observer_1.ResizeObserver(e))?void 0:n.observe)&&e.call(n,document.body)}),(0,vue_1.onMounted)(function(){var e;null!=(e=null==l?void 0:l.value)&&e.addEventListener("mousedown",j),null!=(e=null==l?void 0:l.value)&&e.addEventListener("touchstart",S)}),(0,vue_1.onBeforeUnmount)(function(){var e;null!=n&&n.disconnect(),null!=(e=null==l?void 0:l.value)&&e.removeEventListener("mousedown",j),null!=(e=null==l?void 0:l.value)&&e.removeEventListener("touchstart",S)}),function(){return(0,_vue.createVNode)("div",{ref:l,class:selectorPrefix},[(0,_vue.createVNode)("canvas",{ref:v},null)])}}});
//# sourceMappingURL=writingboard.js.map
