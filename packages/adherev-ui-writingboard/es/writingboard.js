import{createVNode as _createVNode}from"vue";import"core-js/modules/es.array.iterator.js";import"core-js/modules/es.map.js";import"core-js/modules/es.object.to-string.js";import"core-js/modules/es.string.iterator.js";import"core-js/modules/esnext.map.delete-all.js";import"core-js/modules/esnext.map.every.js";import"core-js/modules/esnext.map.filter.js";import"core-js/modules/esnext.map.find.js";import"core-js/modules/esnext.map.find-key.js";import"core-js/modules/esnext.map.includes.js";import"core-js/modules/esnext.map.key-of.js";import"core-js/modules/esnext.map.map-keys.js";import"core-js/modules/esnext.map.map-values.js";import"core-js/modules/esnext.map.merge.js";import"core-js/modules/esnext.map.reduce.js";import"core-js/modules/esnext.map.some.js";import"core-js/modules/esnext.map.update.js";import"core-js/modules/web.dom-collections.iterator.js";import{__assign}from"tslib";import debounce from"lodash/debounce";import{defineComponent,onBeforeUnmount,onMounted,ref}from"vue";import{number,string}from"vue-types";import Util from"@baifendian/adherev-util";import{ResizeObserver}from"@juggle/resize-observer";import{Mode}from"./types";var selectorPrefix="adherev-ui-writingboard",props={defaultMode:string().def(Mode.FREE),defaultStrokeStyle:string().def("#000"),defaultLineWidth:number().def(2),resizeTime:number().def(300)};export default defineComponent({name:"adv-writingboard",props:props,setup:function(t,e){var e=e.expose,n=ref(),v=ref(),c=null,l=null,o=null,i=null,u=t.defaultMode,r=t.defaultLineWidth,a=t.defaultStrokeStyle,s=[],d=new Map([[Mode.FREE,{draw:function(e){var t=e.sourcePoint,e=e.targetPoint;null!=c&&c.beginPath(),null!=c&&c.moveTo(t.x,t.y),null!=c&&c.lineTo(e.x,e.y),s.push({shape:u,sourcePoint:t,targetPoint:e}),h({lineWidth:r,strokeStyle:a}),null!=c&&c.stroke()},drawStack:function(e){null!=c&&c.beginPath(),null!=c&&c.moveTo(e.sourcePoint.x,e.sourcePoint.y),null!=c&&c.lineTo(e.targetPoint.x,e.targetPoint.y),h({lineWidth:e.lineWidth,strokeStyle:e.strokeStyle}),null!=c&&c.stroke()},mouseup:function(e){P({sourcePoint:i,targetPoint:e})}}],[Mode.LINE,{draw:function(e){var t,e=e.targetPoint;null!=c&&c.clearRect(0,0,null==(t=v.value)?void 0:t.width,null==(t=v.value)?void 0:t.height),f(),null!=c&&c.beginPath(),null!=c&&c.moveTo(o.x,o.y),null!=c&&c.lineTo(e.x,e.y),h({lineWidth:r,strokeStyle:a}),null!=c&&c.stroke()},drawStack:function(e){null!=c&&c.beginPath(),null!=c&&c.moveTo(e.sourcePoint.x,e.sourcePoint.y),null!=c&&c.lineTo(e.targetPoint.x,e.targetPoint.y),h({lineWidth:e.lineWidth,strokeStyle:e.strokeStyle}),null!=c&&c.stroke()},mouseup:function(e){s.push({shape:u,lineWidth:null==c?void 0:c.lineWidth,strokeStyle:null==c?void 0:c.strokeStyle,sourcePoint:o,targetPoint:e})}}],[Mode.RECTANGLE,{draw:function(e){var e=e.targetPoint,t=(null!=c&&c.clearRect(0,0,null==(t=v.value)?void 0:t.width,null==(t=v.value)?void 0:t.height),f(),null!=c&&c.beginPath(),y({startPoint:o,targetPoint:e}));null!=c&&c.rect(t.x,t.y,Math.abs(e.x-o.x),Math.abs(e.y-o.y)),h({lineWidth:r,strokeStyle:a}),null!=c&&c.stroke()},drawStack:function(e){null!=c&&c.beginPath(),null!=c&&c.rect(e.x,e.y,e.width,e.height),h({lineWidth:e.lineWidth,strokeStyle:e.strokeStyle}),null!=c&&c.stroke()},mouseup:function(e){var t=y({startPoint:o,targetPoint:e});s.push({shape:u,lineWidth:null==c?void 0:c.lineWidth,strokeStyle:null==c?void 0:c.strokeStyle,x:t.x,y:t.y,width:Math.abs(e.x-(null==o?void 0:o.x)),height:Math.abs(e.y-(null==o?void 0:o.y))})}}],[Mode.CIRCLE,{draw:function(e){var e=e.targetPoint,t=(null!=c&&c.clearRect(0,0,null==(t=v.value)?void 0:t.width,null==(t=v.value)?void 0:t.height),f(),null!=c&&c.beginPath(),y({startPoint:o,targetPoint:e})),e=g({p2:e,p1:o});null!=c&&c.ellipse(t.x,t.y,e,e,45*Math.PI/180,0,2*Math.PI),h({lineWidth:r,strokeStyle:a}),null!=c&&c.stroke()},drawStack:function(e){null!=c&&c.beginPath(),null!=c&&c.ellipse(e.x,e.y,e.radiusX,e.radiusY,e.rotation,e.startAngle,e.endAngle),h({lineWidth:e.lineWidth,strokeStyle:e.strokeStyle}),null!=c&&c.stroke()},mouseup:function(e){var t=y({startPoint:o,targetPoint:e}),e=g({p2:e,p1:o});s.push({shape:u,lineWidth:null==c?void 0:c.lineWidth,strokeStyle:null==c?void 0:c.strokeStyle,x:t.x,y:t.y,radiusX:e,radiusY:e,rotation:45*Math.PI/180,startAngle:0,endAngle:2*Math.PI})}}],[Mode.TRIANGLE,{draw:function(e){var e=e.targetPoint,t=(null!=c&&c.clearRect(0,0,null==(t=v.value)?void 0:t.width,null==(t=v.value)?void 0:t.height),f(),null!=c&&c.beginPath(),m({startPoint:o,targetPoint:e}));null!=c&&c.moveTo(t[0].x,t[0].y),null!=c&&c.lineTo(t[1].x,t[1].y),null!=c&&c.lineTo(t[2].x,t[2].y),null!=c&&c.closePath(),h({lineWidth:r,strokeStyle:a}),null!=c&&c.stroke()},drawStack:function(e){null!=c&&c.beginPath(),null!=c&&c.moveTo(e.points[0].x,e.points[0].y),null!=c&&c.lineTo(e.points[1].x,e.points[1].y),null!=c&&c.lineTo(e.points[2].x,e.points[2].y),null!=c&&c.closePath(),h({lineWidth:e.lineWidth,strokeStyle:e.strokeStyle}),null!=c&&c.stroke()},mouseup:function(e){e=m({startPoint:o,targetPoint:e});s.push({shape:u,lineWidth:null==c?void 0:c.lineWidth,strokeStyle:null==c?void 0:c.strokeStyle,points:e})}}],[Mode.RUBBER,{draw:function(e){var t=e.sourcePoint,e=e.targetPoint;null!=c&&c.beginPath(),null!=c&&c.moveTo(t.x,t.y),null!=c&&c.lineTo(e.x,e.y),s.push({shape:u,sourcePoint:t,targetPoint:e}),c.lineWidth=15,c.strokeStyle="#fff",c.lineCap="round",c.lineJoin="round",null!=c&&c.stroke()},drawStack:function(e){null!=c&&c.beginPath(),null!=c&&c.moveTo(e.sourcePoint.x,e.sourcePoint.y),null!=c&&c.lineTo(e.targetPoint.x,e.targetPoint.y),c.lineWidth=15,c.strokeStyle="#fff",c.lineCap="round",c.lineJoin="round",null!=c&&c.stroke()},mouseup:function(e){P({sourcePoint:i,targetPoint:e})}}]]);function h(e){var t=e.lineWidth,e=e.strokeStyle;c.lineWidth=t,c.strokeStyle=e,c.lineCap="round",c.lineJoin="round"}function m(e){var t=e.startPoint,e=e.targetPoint,n=y({startPoint:t,targetPoint:e}),l=Math.abs(e.x-t.x),e=Math.abs(e.y-t.y);return[{x:n.x,y:n.y+e},{x:n.x+l/2,y:n.y},{x:n.x+l,y:n.y+e}]}function p(e){var t=e.clientX,e=e.clientY,n=null==(n=null==v?void 0:v.value)?void 0:n.getBoundingClientRect();return{x:t-n.x,y:e-n.y}}function g(e){var t=e.p1,e=e.p2,n=t.x,t=t.y,l=e.x,e=e.y;return Math.sqrt(Math.pow(l-n,2)+Math.pow(e-t,2))}function f(){for(var e=0;e<s.length;e++){var t=s[e];d.get(t.shape).drawStack(t)}}function y(e){var t=e.startPoint,e=e.targetPoint;return e.x<=t.x&&e.y<=t.y?e:e.x<=t.x&&e.y>=t.y?{x:e.x,y:t.y}:e.x>=t.x&&e.y<=t.y?{x:t.x,y:e.y}:e.x>=t.x&&e.y>=t.y?t:void 0}function P(e){var t=e.sourcePoint,e=e.targetPoint;(null==d?void 0:d.get(u)).draw({sourcePoint:t,targetPoint:e})}function x(e){T(e)}function k(e){T(__assign(__assign({},e),{clientX:e.targetTouches[0].clientX,clientY:e.targetTouches[0].clientY}))}function S(e){M(e)}function j(e){M(__assign(__assign({},e),{clientX:e.changedTouches[0].clientX,clientY:e.changedTouches[0].clientY}))}function b(e){W(e)}function w(e){W(__assign(__assign({},e),{clientX:e.targetTouches[0].clientX,clientY:e.targetTouches[0].clientY}))}function W(e){var t=e.clientX,e=e.clientY;o=i=p({clientX:t,clientY:e}),null!=(t=null==n?void 0:n.value)&&t.addEventListener("mousemove",x),null!=(e=null==n?void 0:n.value)&&e.addEventListener("mouseup",S),null!=(t=null==n?void 0:n.value)&&t.addEventListener("touchmove",k),null!=(e=null==n?void 0:n.value)&&e.addEventListener("touchend",j)}function T(e){e=p({clientX:e.clientX,clientY:e.clientY});P({sourcePoint:i,targetPoint:e}),i=e}function M(e){var t,e=p({clientX:e.clientX,clientY:e.clientY});null!=(t=d.get(u))&&t.mouseup(e),(i=o=null)!=(t=null==n?void 0:n.value)&&t.removeEventListener("mousemove",x),null!=(e=null==n?void 0:n.value)&&e.removeEventListener("mouseup",S),null!=(t=null==n?void 0:n.value)&&t.removeEventListener("touchmove",k),null!=(e=null==n?void 0:n.value)&&e.removeEventListener("touchend",j)}return e({setMode:function(e){u=e},setStrokeStyle:function(e){a=e},setLineWidth:function(e){r=e},clear:function(){var e;null!=c&&c.clearRect(0,0,null==(e=null==v?void 0:v.value)?void 0:e.width,null==(e=null==v?void 0:v.value)?void 0:e.height),i=o=null,s=[]},toDataURL:function(e,t,n){var l,o;if(e){for(var e=Util.colorToRgb(e),i=e[0],u=e[1],r=e[2],a=[],s=null==c?void 0:c.getImageData(0,0,null==(e=null==v?void 0:v.value)?void 0:e.width,null==(e=null==v?void 0:v.value)?void 0:e.height),d=0;d<(null==(l=null==s?void 0:s.data)?void 0:l.length);d+=4)0===s.data[d+3]&&(s.data[d]=i,s.data[d+1]=u,s.data[d+2]=r,s.data[d+3]=255,a.push(d),a.push(d+1),a.push(d+2),a.push(d+3));null!=c&&c.putImageData(s,0,0);e=null==(e=null==v?void 0:v.value)?void 0:e.toDataURL(t||"image/png",n),s=null==c?void 0:c.getImageData(0,0,null==(o=null==v?void 0:v.value)?void 0:o.width,null==(o=null==v?void 0:v.value)?void 0:o.height);return a.forEach(function(e){s.data[e]=0}),null!=c&&c.putImageData(s,0,0),e}return null==(o=null==v?void 0:v.value)?void 0:o.toDataURL(t||"image/png",n)}}),onMounted(function(){c=null==(e=null==v?void 0:v.value)?void 0:e.getContext("2d");var e=debounce(function(){var e;v.value.width=null==(e=null==n?void 0:n.value)?void 0:e.offsetWidth,v.value.height=null==(e=null==n?void 0:n.value)?void 0:e.offsetHeight,null!=c&&c.clearRect(0,0,null==(e=null==v?void 0:v.value)?void 0:e.width,null==(e=null==v?void 0:v.value)?void 0:e.height),f()},t.resizeTime);null!=(e=null==(l=new ResizeObserver(e))?void 0:l.observe)&&e.call(l,document.body)}),onMounted(function(){var e;null!=(e=null==n?void 0:n.value)&&e.addEventListener("mousedown",b),null!=(e=null==n?void 0:n.value)&&e.addEventListener("touchstart",w)}),onBeforeUnmount(function(){var e;null!=l&&l.disconnect(),null!=(e=null==n?void 0:n.value)&&e.removeEventListener("mousedown",b),null!=(e=null==n?void 0:n.value)&&e.removeEventListener("touchstart",w)}),function(){return _createVNode("div",{ref:n,class:selectorPrefix},[_createVNode("canvas",{ref:v},null)])}}});
//# sourceMappingURL=writingboard.js.map
